name: Sieve Master Deep Audit

on:
  workflow_dispatch:
  schedule:
    - cron: '0 */4 * * *'

jobs:
  audit:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip wget curl jq psmisc

      - name: Initialize Config Structure
        run: |
          mkdir -p TEMPLATES
          # Create CONFIG.JSON with updated file names if it doesn't exist
          if [ ! -f CONFIG.JSON ]; then
            cat <<EOF > CONFIG.JSON
            {
              "FILES": {
                "RAW_LINKS": "raw_links.txt",
                "DEAD_CACHE": "dead_cache.txt",
                "CLEANUP_LOG": "last_cleanup.txt",
                "LOCK_FILE": "system.lock",
                "TEMP_POOL": "audit_snapshot.json",
                "RESULTS": {
                  "ELITE": "Elite_Gemini.txt",
                  "STABLE": "Stable_Chat.txt",
                  "FAST": "Fast_NoGoogle.txt"
                }
              },
              "BINARIES": {
                "XRAY": "./xray",
                "LIBRESPEED": "./librespeed-cli"
              },
              "NETWORK": {
                "MAX_CONCURRENT": 10,
                "BATCH_SIZE": 20,
                "BASE_PORT": 20000,
                "XRAY_WAIT": 4,
                "TIMEOUT_SUB": 30
              },
              "THRESHOLDS": {
                "SPEED_ELITE": 5.0,
                "SPEED_STABLE": 1.5,
                "SPEED_FAST": 0.5
              },
              "URLS": {
                "GEMINI_CHECK": "https://generativelanguage.googleapis.com",
                "GOOGLE_CHECK": "https://www.google.com"
              }
            }
          EOF
          fi
          
          # Create XRAY Template if it doesn't exist
          if [ ! -f TEMPLATES/XRAY_BASE.JSON ]; then
            cat <<EOF > TEMPLATES/XRAY_BASE.JSON
            {
              "log": {"loglevel": "none"},
              "inbounds": [{"port": 1080, "protocol": "socks", "settings": {"udp": true}}],
              "outbounds": [{"tag": "direct", "protocol": "freedom"}]
            }
          EOF
          fi

      - name: Install Xray-core
        run: |
          wget -O xray.zip https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip -q xray.zip xray -d .
          chmod +x ./xray
          rm xray.zip

      - name: Install Librespeed CLI
        run: |
          LATEST_URL=$(curl -s https://api.github.com/repos/librespeed/speedtest-cli/releases/latest \
          | jq -r '.assets[] | select(.name | contains("linux_amd64.tar.gz")) | .browser_download_url')
          wget -O librespeed.tar.gz $LATEST_URL
          tar -xzf librespeed.tar.gz
          mv librespeed-cli* ./librespeed-cli
          chmod +x ./librespeed-cli
          rm librespeed.tar.gz

      - name: Run Sieve Orchestrator
        run: |
          pip install aiohttp
          # Ensure critical files exist before running MAIN.PY
          touch raw_links.txt dead_cache.txt
          python MAIN.PY

      - name: Commit and Push Results
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          if ! git diff --staged --quiet; then
            # Using [skip ci] to prevent recursive workflow triggers
            git commit -m "Audit: $(date -u) [skip ci]"
            git push origin main
          else
            echo "No changes detected to commit."
          fi
